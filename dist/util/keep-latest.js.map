{"version":3,"file":"keep-latest.js","sources":["../../src/util/keep-latest.ts"],"sourcesContent":["import { resource, resourceFactory } from '../core/function-based';\n\nconst isEmpty = (x: undefined | unknown | unknown[]) => {\n  if (Array.isArray(x)) {\n    return x.length === 0;\n  }\n\n  if (typeof x === 'object') {\n    if (x === null) return true;\n\n    return Object.keys(x).length === 0;\n  }\n\n  return x !== 0 && !x;\n};\n\ninterface Options<T = unknown> {\n  /**\n   * A function who's return value, when true, will\n   * keep the latest truthy value as the \"return value\"\n   * (as determined by the `value` option's return value)\n   */\n  when: () => boolean;\n\n  /**\n   * A function who's return value will be used as the value\n   * of this resource.\n   */\n  value: () => T;\n}\n\n/**\n * <div class=\"callout note\">\n *\n * This is not a core part of ember-resources, but is an example utility to demonstrate a concept when authoring your own resources. However, this utility is still under the broader library's SemVer policy.\n *\n * A consuming app will not pay for the bytes of this utility unless imported.\n *\n * </div>\n *\n * A utility decorator for smoothing out changes in upstream data between\n * refreshes / reload.\n *\n * @example\n * when using RemoteData (or some other promise-based \"eventually a value\" resource),\n * the value returned from the API is what's useful to see to users. But if the URL\n * changes, the remote request will start anew, and isLoading becomes true, and the value is falsey until the request finishes. This can result in some flicker\n * until the new request finishes.\n *\n * To smooth that out, we can use [[keepLatest]]\n *\n * ```js\n *  import { RemoteData } from 'ember-resources/util/remote-data';\n *  import { keepLatest } from 'ember-resources/util/keep-latest';\n *\n *  class A {\n *    @use request = RemoteData(() => 'some url');\n *    @use data = keepLatest({\n *      value: () => this.request.value,\n *      when: () => this.request.isLoading,\n *    });\n *\n *    get result() {\n *      // after the initial request, this is always resolved\n *      return this.data;\n *    }\n *  }\n * ```\n */\nexport function keepLatest<Return = unknown>({ when, value: valueFn }: Options<Return>) {\n  return resource(() => {\n    let previous: Return | undefined;\n\n    return () => {\n      let value = valueFn();\n\n      if (when()) {\n        return (previous = isEmpty(value) ? previous : value);\n      }\n\n      return (previous = value);\n    };\n  });\n}\n\nresourceFactory(keepLatest);\n"],"names":["isEmpty","x","Array","isArray","length","Object","keys","keepLatest","when","value","valueFn","resource","previous","resourceFactory"],"mappings":";;;AAEA,MAAMA,OAAO,GAAIC,CAAkC,IAAK;AACtD,EAAA,IAAIC,KAAK,CAACC,OAAO,CAACF,CAAC,CAAC,EAAE;AACpB,IAAA,OAAOA,CAAC,CAACG,MAAM,KAAK,CAAC,CAAA;AACvB,GAAA;AAEA,EAAA,IAAI,OAAOH,CAAC,KAAK,QAAQ,EAAE;AACzB,IAAA,IAAIA,CAAC,KAAK,IAAI,EAAE,OAAO,IAAI,CAAA;IAE3B,OAAOI,MAAM,CAACC,IAAI,CAACL,CAAC,CAAC,CAACG,MAAM,KAAK,CAAC,CAAA;AACpC,GAAA;AAEA,EAAA,OAAOH,CAAC,KAAK,CAAC,IAAI,CAACA,CAAC,CAAA;AACtB,CAAC,CAAA;AAiBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASM,UAAUA,CAAmB;EAAEC,IAAI;AAAEC,EAAAA,KAAK,EAAEC,OAAAA;AAAyB,CAAC,EAAE;EACtF,OAAOC,QAAQ,CAAC,MAAM;AACpB,IAAA,IAAIC,QAA4B,CAAA;AAEhC,IAAA,OAAO,MAAM;AACX,MAAA,IAAIH,KAAK,GAAGC,OAAO,EAAE,CAAA;MAErB,IAAIF,IAAI,EAAE,EAAE;QACV,OAAQI,QAAQ,GAAGZ,OAAO,CAACS,KAAK,CAAC,GAAGG,QAAQ,GAAGH,KAAK,CAAA;AACtD,OAAA;MAEA,OAAQG,QAAQ,GAAGH,KAAK,CAAA;KACzB,CAAA;AACH,GAAC,CAAC,CAAA;AACJ,CAAA;AAEAI,eAAe,CAACN,UAAU,CAAC;;;;"}